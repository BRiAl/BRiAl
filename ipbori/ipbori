#!/usr/bin/env python
# 
# @author Alexander Dreyer
# @date 2007-10-19
# Copyright: (c) 2007-2011 by The PolyBoRi Team
"""ipbori -- An interactive shell for PolyBoRi $PBVERSION.$PBRELEASE

This starts an interactive python-based shell -- IPython where available --
which imports the PolyBoRi framework.

"""

from optparse import OptionParser
parser = OptionParser()

parser.add_option("-t", "--test", 
                  action="store_true", dest="test", default=False,
                  help="Run doctests")

parser.add_option("-v", "--verbose", 
                  action="store_true", dest="verbose", default=False,
                  help="Be eloquent")

(opts, args) = parser.parse_args()

import os, sys

polybori_site = "$RELATIVEPYPREFIX"
polybori_version = "$PBVERSION.$PBRELEASE"

# Note: $PBORI_SITE is replaced on installation with relative path 
# to the PolyBoRi python site
if polybori_site.startswith('$'):
  polybori_site = os.path.join(os.pardir, "pyroot")

if polybori_version.startswith('$'):
  polybori_version = ''

polybori_dir = \
    os.path.normpath(os.path.join(os.path.dirname(os.path.realpath(__file__)),
                                  polybori_site))

sys.path.insert(0, polybori_dir)

def _test(args):
  from glob import glob
  import doctest

  if args:
    files = args
  else:
    files = glob(os.path.join(polybori_dir, 'polybori/*.py'))

  for file in files:
    modname = 'polybori.' + os.path.splitext(os.path.basename(file))[0]

    if modname == 'polybori.parsegat':
      try:
        import pyparsing
      except:
        if opts.verbose: print "Skipping", modname, '...'
        continue

    __import__(modname)
    module = sys.modules[modname]
    doctest.testmod(module, verbose=opts.verbose)


if opts.test:
  _test(args)
  exit(0)

from polybori.frontend import *
polybori_start(globals())

def ipbori_shell(context):
  try:
    try:
      from IPython.frontend.terminal.interactiveshell import \
          TerminalInteractiveShell
      return TerminalInteractiveShell(user_global_ns = context,
                                      display_banner = True)
    except ImportError:
      import IPython.Shell
      return IPython.Shell.start(context)
      
  except:
    # Fallback to plain interactive python
    import code
    sys.ps1 = "In: "
    result = code.InteractiveConsole(context)
    result.mainloop = result.interact
    return result

# Call the available shell
ipbori_shell(globals()).mainloop()

